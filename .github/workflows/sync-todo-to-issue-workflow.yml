name: çµ„ç¹”å†…ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸã‚·ã‚¹ãƒ†ãƒ ğŸ”„

on:
  # ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ™‚ã«å®Ÿè¡Œ
  push:
    paths:
      - '.github/workflows/use-todo-to-issue-workflow.yml'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚ã§ãã‚‹ã‚ˆã†ã«
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆPRã¯ä½œã‚‰ãªã„ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-file:
    runs-on: ubuntu-latest
    # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æˆ¦ç•¥ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒ—ï¼
    strategy:
      matrix:
        target:
          - "stylebikeweb/shopify-email-notifications:main"
          # å¿…è¦ã«å¿œã˜ã¦è¿½åŠ å¯èƒ½
          # - "stylebikeweb/ä»–ã®ãƒªãƒå:main"
      fail-fast: false
    
    # å„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒªãƒã‚¸ãƒˆãƒªã”ã¨ã«ä¸¦åˆ—å‡¦ç†
    name: ${{ matrix.target }}ã¸åŒæœŸä¸­...
    
    # ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´ã‚‚å«ã‚ã¦å–å¾—

      - name: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±ã‚’åˆ†è§£
        id: parse-target
        run: |
          # ã€Œãƒªãƒ:ãƒ–ãƒ©ãƒ³ãƒã€ã‹ã‚‰ãƒªãƒã¨ãƒ–ãƒ©ãƒ³ãƒã«åˆ†å‰²
          TARGET="${{ matrix.target }}"
          REPO="${TARGET%:*}"
          BRANCH="${TARGET#*:}"
          
          echo "ãƒªãƒã‚¸ãƒˆãƒª: $REPO, ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH ã‚’å‡¦ç†ã™ã‚‹ã‚ˆï½"
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: PRä½œæˆæº–å‚™
        id: pr-setup
        run: |
          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’è¨­å®š
          SYNC_DATE=$(date +"%Y.%m.%d")
          echo "SYNC_DATE=$SYNC_DATE" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=sync-todo-workflow-$SYNC_DATE" >> $GITHUB_OUTPUT
          
          # åŒæœŸã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
          SOURCE_FILE=".github/workflows/use-todo-to-issue-workflow.yml"
          echo "SOURCE_FILE=$SOURCE_FILE" >> $GITHUB_OUTPUT
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦æ¸¡ã™æº–å‚™
          FILE_CONTENT=$(base64 -w 0 "$SOURCE_FILE")
          echo "FILE_CONTENT=$FILE_CONTENT" >> $GITHUB_OUTPUT

      - name: ${{ steps.parse-target.outputs.repo }}ã«PRä½œæˆ
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ steps.parse-target.outputs.repo }}
          TARGET_BRANCH: ${{ steps.parse-target.outputs.branch }}
          SOURCE_FILE: ${{ steps.pr-setup.outputs.SOURCE_FILE }}
          FILE_CONTENT: ${{ steps.pr-setup.outputs.FILE_CONTENT }}
          BRANCH_NAME: ${{ steps.pr-setup.outputs.BRANCH_NAME }}
          SYNC_DATE: ${{ steps.pr-setup.outputs.SYNC_DATE }}
        run: |
          # PRã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’è¨­å®š
          PR_TITLE="ğŸ”„ TODOãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ›´æ–° ($SYNC_DATE)"
          PR_BODY="# TODOãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•åŒæœŸã ã‚ˆï½âœ¨\n\n**ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒª**: \`${{ github.repository }}\`\n\n## å¤‰æ›´å†…å®¹\n- \`.github/workflows/use-todo-to-issue-workflow.yml\` ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°\n\n## ç¢ºèªã—ã¦ã»ã—ã„ã“ã¨\n- [ ] ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ã„ã‚‹ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«å½±éŸ¿ãªã„ã‹ç¢ºèªã—ã¦ã­\n\nè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPRã ã‹ã‚‰ã€ç¢ºèªã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã—ã¦ã­ï½"
          
          echo "ğŸ” $TARGET_REPO ã®ãƒ–ãƒ©ãƒ³ãƒ $BRANCH_NAME ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã€ãªã‘ã‚Œã°ä½œæˆ
          if ! gh api repos/$TARGET_REPO/branches/$BRANCH_NAME &>/dev/null; then
            echo "ğŸŒ± æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒ $BRANCH_NAME ã‚’ä½œæˆã™ã‚‹ã‚ˆï½"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              repos/$TARGET_REPO/git/refs \
              -f ref="refs/heads/$BRANCH_NAME" \
              -f sha="$(gh api repos/$TARGET_REPO/git/refs/heads/$TARGET_BRANCH --jq .object.sha)"
          fi
          
          echo "ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªä¸­..."
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          FILE_SHA=$(gh api repos/$TARGET_REPO/contents/$SOURCE_FILE --jq .sha 2>/dev/null || echo "")
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          if [ -n "$FILE_SHA" ]; then
            echo "ğŸ”„ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹ã‚ˆï½"
            gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              repos/$TARGET_REPO/contents/$SOURCE_FILE \
              -f message="ğŸ”„ TODOãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–° ($SYNC_DATE)" \
              -f content="$FILE_CONTENT" \
              -f sha="$FILE_SHA" \
              -f branch="$BRANCH_NAME"
          else
            echo "â• æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã‚ˆï½"
            gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              repos/$TARGET_REPO/contents/$SOURCE_FILE \
              -f message="â• TODOãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ  ($SYNC_DATE)" \
              -f content="$FILE_CONTENT" \
              -f branch="$BRANCH_NAME"
          fi
          
          echo "ğŸ”€ PRã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          # PRãŒã™ã§ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã€ãªã‘ã‚Œã°ä½œæˆ
          EXISTING_PR=$(gh pr list -R $TARGET_REPO -H $BRANCH_NAME -B $TARGET_BRANCH --json number -q '.[0].number')
          if [ -z "$EXISTING_PR" ]; then
            echo "ğŸ”€ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã‚ˆï½"
            gh pr create \
              --repo $TARGET_REPO \
              --base $TARGET_BRANCH \
              --head $BRANCH_NAME \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --label "automation" \
              --label "maintenance"
            
            echo "âœ… PRä½œæˆå®Œäº†ï¼ãƒªãƒã‚¸ãƒˆãƒªã‚’è¦‹ã¦ã¿ã¦ã­ï½"
          else
            echo "ğŸ”„ æ—¢å­˜ã®PR (#$EXISTING_PR) ã‚’æ›´æ–°ã—ãŸã‚ˆï½"
          fi

      - name: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          TARGET_REPO: ${{ steps.parse-target.outputs.repo }}
          TARGET_BRANCH: ${{ steps.parse-target.outputs.branch }}
          SOURCE_FILE: ${{ steps.pr-setup.outputs.SOURCE_FILE }}
          BRANCH_NAME: ${{ steps.pr-setup.outputs.BRANCH_NAME }}
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œä¸­..."
          echo "å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: $TARGET_REPO"
          echo "å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ: $TARGET_BRANCH"
          echo "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $SOURCE_FILE"
          echo "PRç”¨ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
          echo "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒæœŸã•ã‚Œã¾ã™ï¼ˆå®Ÿéš›ã®PRã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ï¼‰"
