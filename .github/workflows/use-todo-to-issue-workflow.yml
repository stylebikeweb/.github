# https://github.com/stylebikeweb/.github/blob/main/.github/workflows/use-todo-to-issue-workflow.yml
# ã‹ã‚‰è¤‡è£½ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚å¤‰æ›´ã¯â†‘ã«é©ç”¨ã™ã‚‹ã¹ã—ï¼ï¼ˆãƒ†ã‚¹ãƒˆä¸­.ï¼‰
name: Use TODO to ISSUE Workflow

# ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹è¨­å®šï½
on:
  # ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  push:
    branches: [main, dev, develop]
  # æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹è¨­å®š
  workflow_dispatch:
    inputs:
      MANUAL_COMMIT_REF:
        description: "The SHA of the commit to get the diff for"
        required: true
      MANUAL_BASE_REF:
        description: "By default, the commit entered above is compared to the one directly before it; to go back further, enter an earlier SHA here"
        required: false

jobs:
  # ===============================================================
  # ğŸ” TODOã‚’Issueã«å¤‰æ›ã™ã‚‹ã‚¸ãƒ§ãƒ–
  # - ã‚³ãƒ¼ãƒ‰å†…ã®TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œå‡º
  # - è¦‹ã¤ã‹ã£ãŸã‚‰GitHub Issueã‚’è‡ªå‹•ç”Ÿæˆ
  # - ã‚³ãƒ¡ãƒ³ãƒˆã«Issueã¸ã®ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥
  # ===============================================================
  todo-to-issue:
    runs-on: "ubuntu-latest"
    # ğŸ” æ¨©é™è¨­å®šï¼šãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹å¤‰æ›´ã¨Issueä½œæˆã®æ¨©é™ãŒå¿…è¦
    permissions:
      contents: write      # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚
      issues: write        # Issueã‚’ä½œæˆã™ã‚‹ãŸã‚
      pull-requests: write # PRã‚’ä½œæˆã™ã‚‹ãŸã‚
    steps:
      - uses: "actions/checkout@v4"
        with:
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯æŒ‡å®šã•ã‚ŒãŸrefã€è‡ªå‹•å®Ÿè¡Œæ™‚ã¯é€šå¸¸ã®refã‚’ä½¿ç”¨
          ref: ${{ github.event.inputs.MANUAL_REF || github.ref }}
      - name: "TODO to Issue"
        uses: "alstr/todo-to-issue-action@v5"
        with:
          # TODOã‚³ãƒ¡ãƒ³ãƒˆã«Issueã®URLã‚’æŒ¿å…¥ã™ã‚‹è¨­å®š
          INSERT_ISSUE_URLS: true
          # å¯¾å¿œã™ã‚‹TODOã‚³ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰Issueã‚‚é–‰ã˜ã‚‹è¨­å®š
          CLOSE_ISSUES: true
          # Issueã®æ‹…å½“è€…ã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦
          AUTO_ASSIGN: true
          # ã©ã®ã‚¿ã‚°ã‚’ã©ã‚“ãªãƒ©ãƒ™ãƒ«ä»˜ãã®Issueã«å¤‰æ›ã™ã‚‹ã‹ã®è¨­å®š
          IDENTIFIERS: '[{"name":"TODO","labels":["enhancement"]},{"name":"FIXME","labels":["bug"]}]'
       # ğŸ¤– GitHubãƒœãƒƒãƒˆã¨ã—ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®š
      - name: Set Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      # ğŸ“ è¿½åŠ ã•ã‚ŒãŸIssueã®URLã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: Commit and Push Changes
        run: |
          git add -A
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
          if [[ `git status --porcelain` ]]; then
            echo "âœ… å¤‰æ›´ã‚’æ¤œå‡ºã—ãŸã‚ˆï¼ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã­ã€œ"
            git commit -m "${{ inputs.COMMIT_MESSAGE }}"
            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã—ã¦ã€ãã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ï¼
            CURRENT_BRANCH=$(git symbolic-ref --short HEAD || echo "main")
            echo "ğŸ“¤ å¤‰æ›´ã‚’ ${CURRENT_BRANCH} ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆï¼"
            git push origin $CURRENT_BRANCH
          else
            echo "âŒ å¤‰æ›´ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ... åŸå› ã‚’èª¿æŸ»ã—ã‚ˆã†ï¼"
            echo "ã‚‚ã—ã‹ã—ã¦ï¼š"
            echo "1. TODOã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ãªã„ï¼Ÿ"
            echo "2. æ¨©é™ã®å•é¡Œã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã§ãã¦ã„ãªã„ï¼Ÿ"
            echo "3. gitã®è¨­å®šã«å•é¡ŒãŒã‚ã‚‹ï¼Ÿ"
          fi
