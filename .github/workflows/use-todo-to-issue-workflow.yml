# https://github.com/stylebikeweb/.github/.github/workflows/use-todo-to-issue-workflow.yml
# ã‹ã‚‰è¤‡è£½ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚å¤‰æ›´ã¯ â†‘â†‘â†‘ ã«é©ç”¨ã™ã‚‹ã¹ã—ï¼
# 
# ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰ã®æ›´æ–°
# 1. GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã€ŒSettingsã€â†’ã€ŒDeveloper settingsã€
#      â†’ã€ŒPersonal access tokensã€â†’ã€ŒTokens (classic)ã€ã¸ç§»å‹•
#   1. æ—¢å­˜ã®ã€ŒFILE_SYNC_TOKENã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é¸æŠ
#   2. ã€ŒRegenerate tokenã€ã‚’ã‚¯ãƒªãƒƒã‚¯
#   3. æœŸé–“ã¯é©å½“ã«è¨­å®šï¼ˆã‚ã¾ã‚Šé•·ã™ããªã„ã»ã†ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«GOODï¼‰
#   4. æ¨©é™ã¯æœ€ä½é™ã€ã€Œrepoã€ã¨ã€Œworkflowã€ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
#   5. ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ã‹ã‚‰æ³¨æ„ï¼‰
# 2. çµ„ç¹”ã® .github ãƒªãƒã‚¸ãƒˆãƒªã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ 
#   1. ãƒªãƒã‚¸ãƒˆãƒªã®ã€ŒSettingsã€â†’ã€ŒSecrets and variablesã€â†’ã€ŒActionsã€ã¸ç§»å‹•
#   2. ã€ŒNew repository secretã€ã‚’ã‚¯ãƒªãƒƒã‚¯
#   3. åå‰: FILE_SYNC_TOKEN
#   4. å€¤: ã•ã£ãã‚³ãƒ”ãƒ¼ã—ãŸPATã‚’ãƒšãƒ¼ã‚¹ãƒˆ
#   5. ã€ŒAdd secretã€ã‚’ã‚¯ãƒªãƒƒã‚¯

name: Use TODO to ISSUE Workflow

# ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹è¨­å®šï½
on:
  # ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  push:
    branches: [main, dev, develop]
  # æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹è¨­å®š
  workflow_dispatch:
    inputs:
      MANUAL_COMMIT_REF:
        description: "The SHA of the commit to get the diff for"
        required: true
      MANUAL_BASE_REF:
        description: "By default, the commit entered above is compared to the one directly before it; to go back further, enter an earlier SHA here"
        required: false

jobs:
  # ===============================================================
  # ğŸ” TODOã‚’Issueã«å¤‰æ›ã™ã‚‹ã‚¸ãƒ§ãƒ–
  # - ã‚³ãƒ¼ãƒ‰å†…ã®TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œå‡º
  # - è¦‹ã¤ã‹ã£ãŸã‚‰GitHub Issueã‚’è‡ªå‹•ç”Ÿæˆ
  # - ã‚³ãƒ¡ãƒ³ãƒˆã«Issueã¸ã®ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥
  # ===============================================================
  todo-to-issue:
    runs-on: "ubuntu-latest"
    # ğŸ” æ¨©é™è¨­å®šï¼šãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹å¤‰æ›´ã¨Issueä½œæˆã®æ¨©é™ãŒå¿…è¦
    permissions:
      contents: write      # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚
      issues: write        # Issueã‚’ä½œæˆã™ã‚‹ãŸã‚
      pull-requests: write # PRã‚’ä½œæˆã™ã‚‹ãŸã‚
    steps:
      - uses: "actions/checkout@v4"
        with:
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯æŒ‡å®šã•ã‚ŒãŸrefã€è‡ªå‹•å®Ÿè¡Œæ™‚ã¯é€šå¸¸ã®refã‚’ä½¿ç”¨
          ref: ${{ github.event.inputs.MANUAL_REF || github.ref }}
      - name: "TODO to Issue"
        uses: "alstr/todo-to-issue-action@v5"
        with:
          # TODOã‚³ãƒ¡ãƒ³ãƒˆã«Issueã®URLã‚’æŒ¿å…¥ã™ã‚‹è¨­å®š
          INSERT_ISSUE_URLS: true
          # å¯¾å¿œã™ã‚‹TODOã‚³ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰Issueã‚‚é–‰ã˜ã‚‹è¨­å®š
          CLOSE_ISSUES: true
          # Issueã®æ‹…å½“è€…ã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦
          AUTO_ASSIGN: true
          # ã©ã®ã‚¿ã‚°ã‚’ã©ã‚“ãªãƒ©ãƒ™ãƒ«ä»˜ãã®Issueã«å¤‰æ›ã™ã‚‹ã‹ã®è¨­å®š
          IDENTIFIERS: '[{"name":"TODO","labels":["enhancement"]},{"name":"FIXME","labels":["bug"]}]'
       # ğŸ¤– GitHubãƒœãƒƒãƒˆã¨ã—ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®š
      - name: Set Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      # ğŸ“ è¿½åŠ ã•ã‚ŒãŸIssueã®URLã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: Commit and Push Changes
        run: |
          git add -A
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
          if [[ `git status --porcelain` ]]; then
            echo "âœ… å¤‰æ›´ã‚’æ¤œå‡ºã—ãŸã‚ˆï¼ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã­ã€œ"
            git commit -m "${{ inputs.COMMIT_MESSAGE }}"
            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã—ã¦ã€ãã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ï¼
            CURRENT_BRANCH=$(git symbolic-ref --short HEAD || echo "main")
            echo "ğŸ“¤ å¤‰æ›´ã‚’ ${CURRENT_BRANCH} ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆï¼"
            git push origin $CURRENT_BRANCH
          else
            echo "âŒ å¤‰æ›´ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ... åŸå› ã‚’èª¿æŸ»ã—ã‚ˆã†ï¼"
            echo "ã‚‚ã—ã‹ã—ã¦ï¼š"
            echo "1. TODOã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ãªã„ï¼Ÿ"
            echo "2. æ¨©é™ã®å•é¡Œã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã§ãã¦ã„ãªã„ï¼Ÿ"
            echo "3. gitã®è¨­å®šã«å•é¡ŒãŒã‚ã‚‹ï¼Ÿ"
          fi
